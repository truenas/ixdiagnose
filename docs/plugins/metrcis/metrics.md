## Metrics

Path: **ixdiagnose/plugins/metrics**
Purpose of Metrics
: Metrics provide a framework for collecting data from different sources. For example, **Directory Tree Metric**
collects data from the directory tree of the folder specified.

How it works?
: Metrics uses methods available in `ixdiagnose/utils`. These methods are used to execute specified methods or
commands and return results to the metrics class.

There is a total of five metrics available right now:
1) Directory Tree Metric
2) File Metric
3) Middleware Metric
4) Python Metric
5) Command Metric

`Directory Tree Metric` is used to collect directory tree of the folder specified.

`File Metric` is used to copy over the specified file to the debug directory.

`Middleware Metric` is used to execute middleware commands and collect data from them.

`Python Metric` is used to execute arbitrary python code and collect data from them - this should be avoided where
possible but in some cases that is not possible for novel cases.

`Command Metric` is used to execute shell commands to collect data from them.

Base Metric Class:
Path: **ixdiagnose/plugins/metrics/base.py**
: Base metric defines basic functionality for other metrics. `base.py` has **Metric** class which contains
following methods:

- __init__(self, name: str, prerequisites: List[Prerequisite] = None):
: Initializes a new instance for **Metric** class. **name** is a string. Name is used to define file name in which the
collected data by metrics will be saved. **Prerequisites** is a list of **Prerequisite** objects which are evaluated
before the execution of the metric.

- **output_file_extension(self) -> str** :
:  Returns a string representing the file extension for the output file generated by the metric.

- **output_file_path(self) -> str** :
: Returns a string representing the full path of the output file generated by the metric. The **base_dir** parameter
specifies the directory in which the output file will be saved.

- **execute(self) -> Tuple[Any, str]**:
: Executes the metric and returns a tuple containing the metric data and any error message encountered during execution.
: `execution_context` provide the directory where the collected data will be saved and **middleware `Client`** to
execute **middleware** commands. The method checks if all the prerequisites are met before executing the metric.
If any of the prerequisites are not met, an error message is returned and then it executes the metric.
The method returns a tuple containing the metric data and any error message encountered during execution.

- **initialize_context(self) -> None**:
: This method is called before executing the metric implementation. It is an optional method that can be overridden
by the metric implementation to initialize the execution context. For example, initializing base directory for
plugins or middleware client.

- **execute_impl(self) -> Tuple[Any, str]**:
: This method is called by the execute method to execute the metric implementation. This method is overwritten by
other metrics. It returns a tuple containing the metric data and any error message encountered during execution.
If the metric execution is successful, the error message should be an empty string.

***Defined Metrics Classes***

Directory Tree Metric:
Path: ixdiagnose/plugins/directory_tree.py
: This metric analyzes directory tree of given path. It uses middleware command `filesystem.listdir` to get the
properties of each file in directories and subdirectories of parent path recursively. Then it writes the result in a
file with specified **name**.

- **get_results(path: str) -> Tuple[List[Dict[str, Any]], List[Dict[str, Optional[str]]]]**:
: This method uses **MiddlewareCommand** class from **ixdiagnose/utils/middleware.py** to execute middleware endpoint
`filesystem.listdir` with given **path** as parameter. It returns a tuple containing two lists: **results** and
**report**. **results** is a list of dictionaries, each of which contains information about a file or directory in the
directory tree. **report** is a list of dictionaries, each of which contains an error message if there was a problem
accessing the directory tree. This method works recursively to get all files/directories in subdirectories in the
directory tree.

File Metric:
Path: ixdiagnose/plugins/metrics/file.py
: This metric accepts a path of a file and file as a new file with specified **name** and **extension**.
: The **FileMetric** class inherits from the **Metric** class. The constructor takes three arguments: **name**
(a string), **file_path** (a string representing the path to the file), and **prerequisites**. An optional
**extension** argument is also provided, which defaults to **.txt**. The **FileMetric** class has the following
methods overridden:

- **execute_impl(self) -> Tuple[Dict, str]**
: **FileMetric** overrides **Metric** class **execute_impl** method. It creates a dictionary called **report**
containing information about the execution of the metric, including an error message if the file could not be found.
The try-except block copies the file to the output directory using the `shutil.copy` function, and sets an error
message in the **report** if the file could not be found.

-  output_file_extension(self) -> str:
: This method is defined to return the value of the extension attribute. It is used to specify extension of the
replicated file.

Middleware Metric:
Path: ixdiagnose/plugins/middleware.py
: This metric uses **MiddlewareClient** and **MiddlewareCommand** class instance from
**ixdiagnose/utils/middleware.py** to execute middleware websocket endpoints and store its results in the file(s) with
specified **names**.
: `MiddlewareClientMetric` inherits from Metric class. It has several methods overridden:

- __init__(self, name: str, middleware_commands: List[MiddlewareCommand], prerequisites: List[Prerequisite] = None):
: This is a constructor method that initializes an instance of the **MiddlewareClientMetric** class. It takes three
parameters, **name**, **middleware_commands**, and **prerequisites**. It calls the constructor of its parent class
**Metric** and initializes some instance variables: **name** and **prerequisites**.

- def get_methods_metadata(cls):
: This is a class method that fetches the methods metadata using the `core.get_methods` middleware command.

- format_output(self, context: list) -> str:
: This method is used to format the output of the middleware commands to make them more readable.

- def initialize_context(self) -> None:
: This method initializes the middleware client.

- execute_impl(self) -> Tuple[Any, str]:
: This method executes the middleware commands and returns a tuple of **metric_report** and **context**. It uses the
execute method of **MiddlewareCommand** class to execute the commands. It also measures the execution time and reports
the execution error.

Python Metric:
Path: ixdiagnose/plugins/python.py
: The **PythonMetric** class accepts python callables, executes it and stores the results in the file with
specified **name**.
: This metric has overridden the following methods:

- __init__():
: This is a constructor method that initializes an instance of the **PythonMetric** class. It takes several parameters,
including **name**, **callback**, **context**, **description**, **prerequisites**, **and **serializable**. It calls
the constructor of its parent class **Metric** and initializes some instance variables: **name** and **prerequisites**.

- output_file_extension(self) -> str:
: This method returns the file extension of the output file, depending on whether the output is serializable or not.

- initialize_context(self) -> None:
: This method initializes the middleware client.

- execute_impl(self) -> Tuple[Any, str]:
: This method executes the **callback** function and returns a tuple of report and output. The **callback** function
accepts a middleware client and **context** as parameters. If the execution is successful, it returns the output.
Otherwise, it returns an error report.

Command Metric
Path: ixdiagnose/plugins/metrics/command.py
: The **CommandMetric** inherits from base class **Metric**.
: The **CommandMetric** class is used to execute one or more shell commands and collect their output with the help of
**Command** class in **ixdiagnose/utils/command.py**.

The **CommandMetric** hase following properties and methods:

#### Properties
- **serializable** a boolean value indicating whether the output of the commands is serializable (i.e., can be
converted to JSON). It checks if all the Command objects are serializable.
- **output_file_extension** a string representing the file extension of the output file, which is either `.json` or
`.txt`, depending on the value of serializable.

#### Methods

- format_data(self, cmd_context: list) -> str:
: This method takes a list of command contexts as input and formats them into a string. The output string will be in
JSON format if the output is serializable, otherwise, it will be in plain text format.

- execute_impl(self) -> Tuple[List, str]:
: This method executes the commands, collects their output, and generates a report. It returns a tuple containing
the report and the formatted data.
: For each command, it executes the command, measures the execution time, and collects the following information:

  - the command itself
  - the error (if any)
  - the execution time
  - the description of the command
  - the return code

## How to add a new Metric?

To add a new metric, follow these steps:

1. Create a new Python file in the **ixdiagnose/plugins/metrics/** directory and give it a meaningful name
e.g. my_metric.py.
2. Define a new class for your metric that extends the **Metric** base class.
3. In the constructor of your metric class, define a name for the metric and specify any prerequisites that are
required for the metric to execute.
4. Implement the `execute_impl` method of your metric class to perform the actual work of the metric.
5. Implement the output_file_path and format_data methods to specify where the output should be written and how
it should be formatted.

Here is an example template for a new metric class:
```commandline
import os
from typing import Any, List, Tuple

from ixdiagnose.plugins.prerequisites.base import Prerequisite
from ixdiagnose.plugins.metrics.base import Metric


class MyMetric(Metric):

    def __init__(self, name: str, prerequisites: List[Prerequisite] = None):
        super().__init__(name, prerequisites)

    def execute_impl(self) -> Tuple[Any, str]:
        # TODO: Implement the logic for your metric here.
        pass

    def output_file_path(self, base_dir: str) -> str:
        # TODO: Specify the path where the output should be written.
        return os.path.join(base_dir, f'{self.name}.json')

    def format_data(self, data: Any) -> str:
        # TODO: Format the output data if necessary.
        pass
```

You can also see already added metrics under **ixdiagnose/plugins/metrics/**.
